---
layout: post
title: Close and Dispose ... The using Statement
date: 2008-02-01 18:48
author: John
comments: true
categories: [All]
---
The <a href="http://msdn.microsoft.com/library/default.asp?url=/library/en-us/csspec/html/vclrfcsharpspec_8_13.asp"><i>using</i> statement</a> is another awesome tool that helps reduce coding effort and possible issues. An attentive reader added a good comment to <a HREF="/blogs/john.papa/archive/2005/03/31/60948.aspx">my last post</a> on using CommandBehavior.CloseConnection to close your Connection object automatically when your DataReader closes. (Thanks for the lead in <a HREF="/blogs/john.papa/archive/2005/03/31/60948.aspx#60961">Wolfgang</a>!) The using statement will close all of your objects and dispose of them for you. This is one of my personal favorites as it can make development a lot easier. (Any code that helps you clean up after yourself gets my vote.) <br> <br> Here is a code block without using the <i>using</i> statement that explicitly disposes of its ADO.NET objects. <fieldset><legend>Sans using</legend> <font color="000000" size="2"> <br> <font color="0000ff" size="2">private void</font> Button2_Click(<font color="0000ff" size="2">object</font> sender, System.EventArgs e) <br> { <br> &nbsp;&nbsp;&nbsp;&nbsp;TextBox1.Text = ""; <br> &nbsp;&nbsp;&nbsp;&nbsp;Label1.Text = ""; <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">string</font> sConnString = "Server=localhost\\sql;Database=Northwind;Integrated Security=True"; <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">string</font> sSql = "SELECT CategoryID, CategoryName FROM Categories ORDER BY CategoryName"; <br> &nbsp;&nbsp;&nbsp;&nbsp;SqlConnection cn = <font color="0000ff" size="2">null</font>; <br> &nbsp;&nbsp;&nbsp;&nbsp;SqlCommand cmd = <font color="0000ff" size="2">null</font>; <br> &nbsp;&nbsp;&nbsp;&nbsp;SqlDataReader rdr = <font color="0000ff" size="2">null</font>; <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">try</font> <br> &nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cn = <font color="0000ff" size="2">new</font> SqlConnection(sConnString); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd = <font color="0000ff" size="2">new</font> SqlCommand(sSql, cn); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cn.Open(); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdr = cmd.ExecuteReader(); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">while</font> (rdr.Read()) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextBox1.Text += rdr["CategoryName"].ToString() + Environment.NewLine; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">catch</font>(Exception ex) <br> &nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label1.Text = ex.Message; <br> &nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">finally</font> <br> &nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">if</font> ((rdr != <font color="0000ff" size="2">null</font>) && (!rdr.IsClosed)) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdr.Close(); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">if</font> (cmd != <font color="0000ff" size="2">null</font>) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmd.Dispose(); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">if</font> (cn != <font color="0000ff" size="2">null</font>) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cn.Dispose(); <br> &nbsp;&nbsp;&nbsp;&nbsp;} <br> } <br> </font> </fieldset> <br> <br> Notice that this preceding code uses the <i>finally</i> block to clean up after itself. This code can easily be forgotten, mistyped, or in my case badly cut and pasted when you are in a hurry. There is nothing wrong with using the <i>finally</i> block for cleaning up, that is one of its intentions. But there is another way to tackle this clean up effort using the <i>using</i> statement. <br> <br> The following code sample also cleans up after itself, but it does so using the <i>using</i> statement instead of an explicit call to the close and dispose methods. Again, this is one of my favorite tools in .NET. The <i>using</i> statement handles the disposal and subsequent closing of my objects for me. Even if an exception is thrown, as soon as execution leaves the <i>using</i> block the DIspose method of the object is invoked under the covers. For objects like the SqlConnection, this also closes the connection too. Quite a nice feature! <br> <br> <fieldset><legend>Using using</legend> <font color="000000" size="2"> <br> <font color="0000ff" size="2">private void</font> Button3_Click(<font color="0000ff" size="2">object</font> sender, System.EventArgs e) <br> { <br> &nbsp;&nbsp;&nbsp;&nbsp;TextBox1.Text = ""; <br> &nbsp;&nbsp;&nbsp;&nbsp;Label1.Text = ""; <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">string</font> sConnString = "Server=localhost\\sql;Database=Northwind;Integrated Security=True"; <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">string</font> sSql = "SELECT CategoryID, CategoryName FROM Categories ORDER BY CategoryName"; <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">try</font> <br> &nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">using</font> (SqlConnection cn = <font color="0000ff" size="2">new</font> SqlConnection(sConnString)) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">using</font> (SqlCommand cmd = <font color="0000ff" size="2">new</font> SqlCommand(sSql, cn)) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cn.Open(); <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">using</font> (SqlDataReader rdr = cmd.ExecuteReader()) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">while</font> (rdr.Read()) <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextBox1.Text += rdr["CategoryName"].ToString() + Environment.NewLine; <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;} <br> &nbsp;&nbsp;&nbsp;&nbsp;<font color="0000ff" size="2">catch</font>(Exception ex) <br> &nbsp;&nbsp;&nbsp;&nbsp;{ <br> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Label1.Text = ex.Message; <br> &nbsp;&nbsp;&nbsp;&nbsp;} <br> } <br> </font> </fieldset> <br> <br> While either of these 2 code examples will work and clean up after themselves, I prefer to code with the <i>using</i> statement. To me, it is easier to read and it saves me from having to write the cleanup code. <br> <br> One last note with the <i>using</i> statement that you may run into: Just like a <i>try</i> block, anything declared within the <i>using</i> statement can only be accessed within its block. If you want to refer to it outside of the <i>using</i> statement (or <i>try</i> block), then declare it prior to and outside of them.</li> <br> <br> For you VB.NET'ers o
ut there, the <i>using</i> statement will be available in VB.NET in the reelase of Visual Studio .NET 2005. The syntax looks to be as follows: <br> <br> <fieldset><legend>Using in VB.NET</legend> <font color="000000" size="2"> <br> <font color="0000ff" size="2">Using</font> cn <font color="0000ff" size="2">As</font> SqlConnection = <font color="0000ff" size="2">New</font> SqlConnection(sConnString) <br> &nbsp;&nbsp;&nbsp;&nbsp;'--- Do something <br> <font color="0000ff" size="2">End Using</font> <br> </font> </fieldset> <br> <br>

