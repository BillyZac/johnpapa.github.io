---
layout: post
title: Getting GrandParent columns with ADO.NET
date: 2008-02-01 18:49
author: John
comments: true
categories: [All]
---
I've recently had a flurry of email asking how to navigate up to a grandparent table using ADO.NET. Assuming that it is not preferable to export all of the data to Xml and use an XPath, ADO.NET offers a few other ADO.NET based solutions. One solution is to use expression based columns. (If you want more of an explanation of how to use expression based columns in ADO.NET, see my <a href="http://msdn.microsoft.com/msdnmag/find/default.aspx?type=Ti&amp;phrase=Data%20Points&amp;words=exact">Data Points</a> article <a href="http://msdn.microsoft.com/msdnmag/issues/03/01/DataPoints/">here</a> in <a href="http://msdn.microsoft.com/msdnmag/">MSDN Magazine</a>.) &nbsp; <br /><br />To explain both solutions, I created a DataSet that contains 3 DataTables. The DataTable objects represent Customers, Orders and Order Details from the SQL Server Northwind database. I also create a DataRelation between the Customers and its child table, Orders. Then I create another DataRelation between the Orders and its child table, Order Details. At the end of this code sample, shown below, I have a DataSet with Customers, their Orders and their Order Details linked through relations. <br /><br /> <fieldset style="LEFT: 10px; TOP: 1320px"><legend>Filling the DataSet with Customers, Orders and Order Details</legend><pre><span style="FONT-SIZE: 9pt; COLOR: black; FONT-FAMILY: Arial"><span style="COLOR: blue">string</span> sCn = "server=(local);database=northwind;integrated security=true;"; DataSet ds = <span style="COLOR: blue">new</span> DataSet(); <span style="COLOR: blue">using</span> (SqlConnection cn = <span style="COLOR: blue">new</span> SqlConnection(sCn)) { cn.Open(); <span style="COLOR: green">// Get the Customers</span> <span style="COLOR: blue">string</span> sqlCustomers = "SELECT CustomerID, CompanyName, Country " + " FROM Customers ORDER BY CustomerID"; <span style="COLOR: blue">using</span> (SqlCommand cmd = <span style="COLOR: blue">new</span> SqlCommand(sqlCustomers, cn)) <span style="COLOR: blue">using</span> (SqlDataAdapter da = <span style="COLOR: blue">new</span> SqlDataAdapter(cmd)) da.Fill(ds, "Customers"); ds.Tables["Customers"].PrimaryKey = <span style="COLOR: blue">new</span> DataColumn[]{ds.Tables["Customers"].Columns["CustomerID"]}; <span style="COLOR: green">// Get the Orders</span> <span style="COLOR: blue">string</span> sqlOrders = "SELECT OrderID, CustomerID, OrderDate FROM Orders"; <span style="COLOR: blue">using</span> (SqlCommand cmd = <span style="COLOR: blue">new</span> SqlCommand(sqlOrders, cn)) <span style="COLOR: blue">using</span> (SqlDataAdapter da = <span style="COLOR: blue">new</span> SqlDataAdapter(cmd)) da.Fill(ds, "Orders"); ds.Tables["Orders"].PrimaryKey = <span style="COLOR: blue">new</span> DataColumn[]{ds.Tables["Orders"].Columns["OrderID"]}; ds.Relations.Add("C2O", ds.Tables["Customers"].Columns["CustomerID"], ds.Tables["Orders"].Columns["CustomerID"]); <span style="COLOR: green">// Get the Order Details</span> StringBuilder sb = <span style="COLOR: blue">new</span> StringBuilder(""); sb.Append("SELECT od.OrderID, p.ProductID, p.ProductName, "); sb.Append(" od.UnitPrice, od.Quantity"); sb.Append(" FROM [Order Details] od "); sb.Append(" INNER JOIN Products p ON od.ProductID = p.ProductID"); string sqlOrderDetails = sb.ToString(); <span style="COLOR: blue">using</span> (SqlCommand cmd = <span style="COLOR: blue">new</span> SqlCommand(sqlOrderDetails, cn)) <span style="COLOR: blue">using</span> (SqlDataAdapter da = <span style="COLOR: blue">new</span> SqlDataAdapter(cmd)) da.Fill(ds, "Order Details"); ds.Tables["Order Details"].PrimaryKey = <span style="COLOR: blue">new</span> DataColumn[]{ds.Tables["Order Details"].Columns["OrderID"], ds.Tables["Order Details"].Columns["ProductID"]}; ds.Relations.Add("O2OD", ds.Tables["Orders"].Columns["OrderID"], ds.Tables["Order Details"].Columns["OrderID"]); cn.Close(); }</span></pre></fieldset> <br /><br />The first solution I mentioned adds an expression column to the Orders and to the Order Details DataTable objects. The expression column in the Orders DataTable navigates up to its parent DataTable (Customers) via a DataRelation and simply gets the value of the Country column. The expression column in the Order Details DataTable navigates up to its parent DataTable (Orders) via a DataRelation and evaluates the expression column in the Orders DataTable to determine if the country is the US or not. <br /><br /> <fieldset style="LEFT: 10px; TOP: 1320px"><legend>Grandparent via Expressions</legend><pre><span style="FONT-SIZE: 9pt; COLOR: black; FONT-FAMILY: Arial"><span style="COLOR: green">// add an expression column, to help out</span> ds.Tables["Orders"].Columns.Add("CustomerCountry", <span style="COLOR: blue">typeof</span>(<span style="COLOR: blue">string</span>), "Parent.Country"); ds.Tables["Order Details"].Columns.Add("CountryType", <span style="COLOR: blue">typeof</span>(<span style="COLOR: blue">string</span>), "Iif(Parent.CustomerCountry = 'US', 'US', 'Foreign Country')"); <span style="COLOR: green">// Find an Order Details Row, just to start things off</span> DataRow row = ds.Tables["Order Details"].Rows.Find(<span style="COLOR: blue">new object[]</span> {"10260", "57"}); <span style="COLOR: green">// Look at the expression column</span> Debug.WriteLine(row["CountryType"]); </span></pre></fieldset> <br />The second solution does not require expression columns. Instead, it uses the GetParentRow method of the DataRow. In this example, I evaluate the Customers.Country field by travelling up from the Order Details row to its parent Orders row and then up to its grandparent Customers row. <fieldset style="LEFT: 10px; TOP: 1320px"><legend>Grandparent via GetParentRow</legend><pre><span style="FONT-SIZE: 9pt; COLOR: black; FONT-FAMILY: Arial"><span style="COLOR: green">// Use the GetParentRow to get the value instead</span> <span style="COLOR: blue">string</span> sCountry = row.GetParentRow("O2OD").GetParentRow("C2O")["Country"].ToString(); Debug.WriteLine((sCountry == "US") ? "US" : "Foreign Country"); </span></pre></fieldset>

